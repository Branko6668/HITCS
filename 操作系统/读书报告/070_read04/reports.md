# 4. 任务管理

## 4.1. 任务管理概述

- ### **什么是任务？**

  - 任务是指在80x86处理器上执行的一个程序或一组程序。每个任务都有自己的执行环境，包括代码、数据、栈、寄存器等。任务可以相互切换，从而实现多任务或并发处理。

- ### **80x86 提供了哪些硬件支持？**

  - 80x86 处理器提供了以下硬件支持来实现任务管理：

  - 任务状态段（Task-State Segment，TSS）：用于保存和恢复任务的执行环境，包括寄存器、栈指针、内存管理信息等。

  - TSS 描述符：用于在全局描述符表（Global Descriptor Table，GDT）或局部描述符表（Local Descriptor Table，LDT）中描述 TSS 的基地址、界限、属性等。

  - 任务寄存器（Task Register，TR）：用于保存当前执行任务的 TSS 描述符的选择子。

  - 任务门描述符（Task-Gate Descriptor）：用于在 GDT 或中断描述符表（Interrupt Descriptor Table，IDT）中描述一个任务的选择子和优先级。

  - 任务切换机制（Task Switching Mechanism）：用于在不同的任务之间切换，保存和恢复任务的执行环境，更新 TR 和相关的标志位。

- ### 描述符表中与任务相关的描述符有哪些？

  - 描述符表中与任务相关的描述符有以下三种：

  - TSS 描述符：用于描述 TSS 的基地址、界限、属性等，可以在 GDT 或 LDT 中出现，用于任务切换或任务调用。

  - 任务门描述符：用于描述一个任务的选择子和优先级，可以在 GDT 或 IDT 中出现，用于任务切换或任务调用。

  - 调用门描述符（Call-Gate Descriptor）：用于描述一个过程的选择子、偏移量和优先级，可以在 GDT、LDT 或 IDT 中出现，用于过程调用。

- ### 任务切换与过程调用的区别是什么？

  - 任务切换和过程调用都是一种控制转移的方式，但它们有以下区别：

  - 任务切换是在不同的任务之间切换，每个任务都有自己的执行环境，任务切换会保存和恢复任务的执行环境，更新 TR 和相关的标志位。任务切换可以由以下事件触发：
    - 任务调用：通过 JMP 或 CALL 指令，使用任务门描述符或 TSS 描述符作为操作数，调用另一个任务。
    - 中断或异常：当发生中断或异常时，如果 IDT 中对应的向量指向一个任务门描述符，那么会切换到该任务门描述符所指向的任务。
    - IRET 指令：当执行 IRET 指令时，如果返回地址指向一个不同的任务，那么会切换到该任务。

  - 过程调用是在同一个任务内部调用一个过程，过程共享任务的执行环境，过程调用只会保存和恢复部分寄存器，不会更新 TR 和相关的标志位。过程调用可以由以下事件触发：
    - 过程调用：通过 JMP 或 CALL 指令，使用调用门描述符或段选择子和偏移量作为操作数，调用一个过程。
    - 中断或异常：当发生中断或异常时，如果 IDT 中对应的向量指向一个调用门描述符或中断门描述符或陷阱门描述符，那么会调用该描述符所指向的过程。
    - RET 指令：当执行 RET 指令时，会返回到调用过程的返回地址。

## 4.1.1. 任务的结构

- ### 一个任务由几部分构成？

  - 一个任务由以下几部分构成：

  - 任务执行空间（Task Execution Space）：用于存放任务的代码、数据、栈等。

  - 任务状态段（Task-State Segment，TSS）：用于保存和恢复任务的执行环境，包括寄存器、栈指针、内存管理信息等。

  - TSS 描述符：用于在 GDT 或 LDT 中描述 TSS 的基地址、界限、属性等。

- ### 任务执行空间包括什么？

  - 任务执行空间包括以下内容：

  - 代码段（Code Segment）：用于存放任务的可执行代码。

  - 数据段（Data Segment）：用于存放任务的全局变量、静态变量、常量等。

  - 栈段（Stack Segment）：用于存放任务的局部变量、参数、返回地址等。

  - 其他段（Other Segments）：用于存放任务的其他信息，如堆、BSS、TLS 等。

- ### 为什么会有多个特权级栈空间？

  - 80x86 处理器支持四个特权级（Privilege Level），从 0 到 3，其中 0 是最高的特权级，3 是最低的特权级。不同的特权级可以访问不同的资源，以实现保护模式下的安全性和可靠性。

  - 当一个任务从一个特权级切换到另一个特权级时，需要使用不同的栈空间，以避免栈的混乱和破坏。因此，一个任务会有多个特权级栈空间，分别对应不同的特权级。这些栈空间的基地址和界限都存放在 TSS 中。

## 4.1.2. 任务状态

- ### 当前正在执行的任务状态包括哪些内容？

  - 当前正在执行的任务状态包括以下内容：

  - 通用寄存器（General Registers）：包括 EAX、EBX、ECX、EDX、ESI、EDI、ESP、EBP 等，用于存放任务的数据和地址。

  - 段寄存器（Segment Registers）：包括 CS、DS、SS、ES、FS、GS 等，用于存放任务的段选择符，指向任务的代码段、数据段、栈段等。

  - 指令指针（Instruction Pointer）：包括 EIP，用于指向当前执行的指令的地址。

  - 标志寄存器（Flag Register）：包括 EFLAGS，用于存放一些状态标志和控制标志，如进位标志、零标志、符号标志、溢出标志、方向标志、中断标志等。

  - 控制寄存器（Control Registers）：包括 CR0、CR1、CR2、CR3、CR4 等，用于控制处理器的一些工作模式和特性，如保护模式、分页模式、缓存模式、调试模式等。

  - 调试寄存器（Debug Registers）：包括 DR0、DR1、DR2、DR3、DR4、DR5、DR6、DR7 等，用于支持调试功能，如设置断点、监视内存、检测异常等。

  - 测试寄存器（Test Registers）：包括 TR3、TR4、TR5、TR6、TR7，用于测试处理器的一些功能，如缓存、TLB、保护机制等。

  - 任务寄存器（Task Register）：包括 TR，用于存放当前执行任务的 TSS 描述符的选择子，指向任务的 TSS 段。

- ### 掌握每一个被包含内容的含义？

  - 要掌握每一个被包含内容的含义，你需要了解以下概念：

  - 寄存器（Register）：是处理器内部的一种高速存储单元，用于暂存和传递数据、地址和控制信息。寄存器的大小和数量取决于处理器的类型和位数，一般有 8 位、16 位、32 位、64 位等不同的寄存器。

  - 段机制（Segmentation Mechanism）：是一种内存管理技术，用于将内存空间划分为不同的段（Segment），每个段有自己的基地址、界限、属性等，用于实现保护模式下的内存隔离和访问控制。段机制需要使用段选择符（Segment Selector）和段描述符（Segment Descriptor）来描述和访问段。

  - 页机制（Paging Mechanism）：是一种内存管理技术，用于将内存空间划分为固定大小的页（Page），每个页有自己的物理地址和虚拟地址，用于实现虚拟内存和内存映射。页机制需要使用页目录（Page Directory）和页表（Page Table）来描述和转换页的地址。

  - 任务机制（Task Mechanism）：是一种多任务处理技术，用于将处理器的执行环境划分为不同的任务（Task），每个任务有自己的代码、数据、栈等，用于实现任务的切换和调度。任务机制需要使用任务状态段（Task-State Segment）和任务门描述符（Task-Gate Descriptor）来描述和访问任务。

- ### 为什么要包含这些内容？

  - 要包含这些内容，是因为它们是任务的执行环境的重要组成部分，决定了任务的运行状态和行为。当任务切换时，处理器会保存和恢复这些内容，以保证任务的正确执行。当任务发生异常或中断时，处理器会检查和修改这些内容，以响应和处理异常或中断。当任务进行调试或测试时，处理器会使用和设置这些内容，以支持调试或测试的功能。

## 4.1.3. 任务的执行

- ### 任务的执行方式有几种？

  - 任务的执行方式有以下三种：

  - 任务调用（Task Call）：通过 JMP 或 CALL 指令，使用任务门描述符或 TSS 描述符作为操作数，调用另一个任务。如果是 JMP 指令，那么会切换到新的任务，并且不会返回。如果是 CALL 指令，那么会切换到新的任务，并且在 TSS 中保存返回地址，以便通过 IRET 指令返回。

  - 中断或异常（Interrupt or Exception）：当发生中断或异常时，如果 IDT 中对应的向量指向一个任务门描述符，那么会切换到该任务门描述符所指向的任务，并且在 TSS 中保存返回地址，以便通过 IRET 指令返回。

  - IRET 指令（IRET Instruction）：当执行 IRET 指令时，如果返回地址指向一个不同的任务，那么会切换到该任务，并且不会返回。

- ### 熟悉掌握每一种执行方式的过程

  - 任务调用的过程如下：

    - 检查操作数是否有效，如果无效，产生异常。

    - 检查访问权限，如果不允许访问，产生异常。

    - 保存当前任务的执行环境到当前任务的 TSS 中。

    - 加载新任务的 TSS 描述符到 TR 寄存器中。

    - 加载新任务的执行环境从新任务的 TSS 中。

    - 如果是 CALL 指令，将返回地址压入新任务的栈中。

    - 开始执行新任务的代码。

  - 中断或异常的过程如下：

    - 检查中断或异常向量是否有效，如果无效，产生异常。

    - 检查访问权限，如果不允许访问，产生异常。

    - 保存当前任务的执行环境到当前任务的 TSS 中。

    - 加载新任务的 TSS 描述符到 TR 寄存器中。

    - 加载新任务的执行环境从新任务的 TSS 中。

    - 将返回地址压入新任务的栈中。

    - 开始执行新任务的代码。

  - IRET 指令的过程如下：

    - 检查返回地址是否有效，如果无效，产生异常。

    - 检查访问权限，如果不允许访问，产生异常。

    - 保存当前任务的执行环境到当前任务的 TSS 中。

    - 加载返回任务的 TSS 描述符到 TR 寄存器中。

    - 加载返回任务的执行环境从返回任务的 TSS 中。

    - 从返回任务的栈中弹出返回地址。

    - 继续执行返回任务的代码。

- ### Linux 0.00 用的是哪种方式？

  - Linux 0.00 是一个基于 80386 处理器的操作系统，它没有使用任务切换的机制，而是使用了过程调用的机制。它只使用了一个 TSS，用于实现用户态和内核态的切换。

- ### 任务可以递归调用吗？为什么？

  - 任务可以递归调用，但是有一定的限制。如果任务 A 调用任务 B，然后任务 B 再调用任务 A，那么会形成一个任务链，任务 A 和任务 B 之间的关系会保存在它们的 TSS 中的先前任务链接字段中。这样，任务 A 可以通过 IRET 指令返回到任务 B，任务 B 可以通过 IRET 指令返回到任务 A。但是，如果任务 A 再次调用任务 B，那么会覆盖任务 B 的先前任务链接字段，导致任务 B 无法返回到任务 A。因此，任务的递归调用需要注意保存和恢复任务链的信息，以避免丢失返回地址。

## 4.2. 任务的数据结构

- ### 任务状态段 Task-State Segment (TSS)

  - 任务状态段是一种系统段，用于保存和恢复任务的执行环境，包括寄存器、栈指针、内存管理信息等。任务状态段的结构如下：
  
    ![](/images/img1.png)

- ### TSS 描述符

  - TSS 描述符是一种系统段描述符，用于在 GDT 或 LDT 中描述 TSS 的基地址、界限、属性等。TSS 描述符的结构如下：
  
    ![](/images/img2.png)

- 其中，各个字段的含义如下：

  - 段界限（Segment Limit）：表示 TSS 的大小，单位为字节，减 1 后的值。如果 G 位为 0，表示段界限的单位是字节；如果 G 位为 1，表示段界限的单位是 4KB。

  - 基地址（Base Address）：表示 TSS 的线性基地址，占 32 位，分散在三个字段中。

  - P（Present）：表示 TSS 是否在内存中，如果为 1，表示在内存中；如果为 0，表示不在内存中，访问该 TSS 会产生异常。

  - DPL（Descriptor Privilege Level）：表示 TSS 的特权级，占 2 位，从 0 到 3，其中 0 是最高的特权级，3 是最低的特权级。

  - B（Busy）：表示 TSS 是否正在被使用，如果为 1，表示正在被使用；如果为 0，表示没有被使用。当任务切换时，处理器会自动设置或清除该位。

  - D（Default Operation Size）：表示 TSS 的操作数大小，如果为 1，表示 32 位；如果为 0，表示 16 位。

  - TYPE（Type）：表示 TSS 的类型，占 4 位，有两种类型：可用的 32 位 TSS（1001）和忙的 32 位 TSS（1011）。

  - G（Granularity）：表示段界限的单位，如果为 1，表示 4KB；如果为 0，表示字节。

  - AV（Available）：表示该位是否可用，可以由软件自由使用。

  - L（64-bit Code Segment）：表示该段是否是 64 位的代码段，对于 TSS 描述符，该位必须为 0。

- ### 任务寄存器

  - 任务寄存器是一种特殊的寄存器，用于存放当前执行任务的 TSS 描述符的选择子。任务寄存器有可见部分和不可见部分，可见部分可以由软件读写，不可见部分只能由处理器访问。任务寄存器的结构如下：

| 位   | 0-15   | 16-31 | 32-47       | 48-63        | 64-79        | 80-95 |
| :--- | :----- | :---- | :---------- | :----------- | :----------- | :---- |
| 0-95 | 选择子 | 保留  | 基地址 15-0 | 基地址 23-16 | 基地址 31-24 | 保留  |

- 其中，各个字段的含义如下：

  - 选择子（Selector）：表示当前任务的 TSS 描述符在 GDT 中的索引，占 16 位，可见部分。

  - 基地址（Base Address）：表示当前任务的 TSS 的线性基地址，占 32 位，分散在三个字段中，不可见部分。

  - 保留（Reserved）：表示保留位，占 32 位，不可见部分。

- ### 任务门描述符 Task-Gate Descriptor

  - 任务门描述符是一种系统门描述符，用于在 GDT 或 IDT 中描述一个任务的选择子和优先级。任务门描述符的结构如下：
  
    ![](/images/img3.png)

- 其中，各个字段的含义如下：

  - P（Present）：表示任务是否在内存中，如果为 1，表示在内存中；如果为 0，表示不在内存中，访问该任务会产生异常。

  - DPL（Descriptor Privilege Level）：表示任务的特权级，占 2 位，从 0 到 3，其中 0 是最高的特权级，3 是最低的特权级。

  - TYPE（Type）：表示任务门的类型，占 4 位，固定为 0101。

  - 选择子（Selector）：表示任务的 TSS 描述符在 GDT 中的索引，占 16 位。

任务门描述符的作用是提供一个间接的、受保护的对 TSS 的引用。当发生任务切换时，处理器会根据任务门描述符中的选择子找到对应的 TSS 描述符，然后切换到该 TSS 所指向的任务。任务门描述符可以用于以下两种情况：

- 任务调用：通过 JMP 或 CALL 指令，使用任务门描述符作为操作数，调用另一个任务。这种情况下，任务门描述符可以存放在 GDT 或 LDT 中，但是必须符合特权级检查的规则。
- 中断或异常：当发生中断或异常时，如果 IDT 中对应的向量指向一个任务门描述符，那么会切换到该任务门描述符所指向的任务。这种情况下，任务门描述符只能存放在 IDT 中，而且必须符合特权级检查的规则。

## 4.3. 任务切换

- ### 什么时候发生任务切换？

  - 任务切换是指处理器从一个任务切换到另一个任务，保存和恢复任务的执行环境，更新 TR 和相关的标志位。任务切换可以由以下事件触发：

  - 任务调用：通过 JMP 或 CALL 指令，使用任务门描述符或 TSS 描述符作为操作数，调用另一个任务。

  - 中断或异常：当发生中断或异常时，如果 IDT 中对应的向量指向一个任务门描述符，那么会切换到该任务门描述符所指向的任务。

  - IRET 指令：当执行 IRET 指令时，如果返回地址指向一个不同的任务，那么会切换到该任务。

- ### 发生任务切换时，处理器会执行哪些操作？

  - 发生任务切换时，处理器会执行以下操作：

  - 检查目标任务的有效性和访问权限，如果无效或不允许访问，产生异常。

  - 保存当前任务的执行环境到当前任务的 TSS 中，包括寄存器、栈指针、内存管理信息等。

  - 加载目标任务的 TSS 描述符到 TR 寄存器中，更新 TR 的不可见部分，包括基地址、界限、属性等。

  - 加载目标任务的执行环境从目标任务的 TSS 中，包括寄存器、栈指针、内存管理信息等。

  - 如果是任务调用或中断或异常，将返回地址压入目标任务的栈中，以便通过 IRET 指令返回。

  - 开始执行目标任务的代码。

- ### 中断或异常向量指向 IDT 表中的中断门或陷阱门，会发生任务切换吗？

  - 如果中断或异常向量指向 IDT 表中的中断门或陷阱门，那么不会发生任务切换，而是发生过程调用。过程调用只会保存和恢复部分寄存器，不会更新 TR 和相关的标志位。过程调用可以在同一个任务内部进行，也可以在不同的任务之间进行，但是不会改变当前任务的状态。

## 4.4. 任务链

- ### 如何判断任务是否嵌套？

  - 任务是否嵌套可以通过 TSS 中的先前任务链接字段来判断。如果该字段为 0，表示该任务没有嵌套。如果该字段不为 0，表示该任务有嵌套，该字段的值是先前任务的 TSS 段选择符。

- ### 什么情况会发生任务嵌套？

  - 任务嵌套是指一个任务在执行过程中调用或切换到另一个任务，然后再返回到原来的任务。任务嵌套可以由以下情况发生：

  - 任务调用：通过 CALL 指令，使用任务门描述符或 TSS 描述符作为操作数，调用另一个任务，然后通过 IRET 指令返回。

  - 中断或异常：当发生中断或异常时，如果 IDT 中对应的向量指向一个任务门描述符，那么会切换到该任务门描述符所指向的任务，然后通过 IRET 指令返回。

- ### 任务嵌套时修改了哪些标志位？

  - 任务嵌套时，处理器会修改以下标志位：

  - NT 标志（Nested Task Flag）：该标志位于 EFLAGS 寄存器的第 14 位，用于表示当前任务是否嵌套。如果为 1，表示当前任务是嵌套的，如果为 0，表示当前任务不是嵌套的。当发生任务切换时，处理器会将 NT 标志的值保存到当前任务的 TSS 中，然后将 NT 标志置为 1。当执行 IRET 指令时，处理器会将 NT 标志的值恢复到 EFLAGS 寄存器中。

  - T 标志（Debug Trap Flag）：该标志位于 TSS 的第 100 字节的第 0 位，用于表示当前任务是否设置了调试陷阱。如果为 1，表示当前任务设置了调试陷阱，当切换到该任务时，会引起调试异常。如果为 0，表示当前任务没有设置调试陷阱。该标志由软件设置，不会被处理器修改。

- ### 任务嵌套时，如何返回前一任务？

  - 任务嵌套时，可以通过执行 IRET 指令来返回前一任务。IRET 指令会从当前任务的栈中弹出返回地址，该返回地址包括一个 TSS 段选择符和一个偏移量。如果该 TSS 段选择符与 TR 寄存器中的值不同，那么会发生任务切换，切换到该 TSS 段选择符所指向的任务。如果该 TSS 段选择符与 TR 寄存器中的值相同，那么不会发生任务切换，而是继续执行当前任务的代码。

## 4.5. 任务地址空间

- ### 什么是任务地址空间？

  - 任务地址空间是指一个任务可以访问的内存空间，包括代码、数据、栈等。任务地址空间由段机制和页机制共同决定，每个任务都有自己的逻辑地址空间、线性地址空间和物理地址空间。

- ### 任务地址空间包括什么？

  - 任务地址空间包括以下内容：

  - 逻辑地址空间（Logical Address Space）：是指任务使用的段选择符和偏移量组成的地址空间，每个段选择符指向一个段描述符，每个段描述符定义了一个段的基地址、界限、属性等。逻辑地址空间由任务的 LDT 和 GDT 共同决定，每个任务都有自己的 LDT，但是共享 GDT。

  - 线性地址空间（Linear Address Space）：是指任务使用的线性地址组成的地址空间，每个线性地址是由逻辑地址经过段机制转换而来的，线性地址空间由任务的段描述符决定，每个任务都有自己的段描述符。

  - 物理地址空间（Physical Address Space）：是指任务使用的物理地址组成的地址空间，每个物理地址是由线性地址经过页机制转换而来的，物理地址空间由任务的页目录和页表决定，每个任务都有自己的页目录和页表。

- ### 了解把任务映射到线性和物理地址空间的方法？

  - 把任务映射到线性和物理地址空间的方法如下：

  - 把逻辑地址映射到线性地址：通过段机制，将逻辑地址的段选择符和偏移量转换为线性地址。具体步骤如下：
    - 从段选择符中提取索引、表指示符和请求特权级。
    - 如果表指示符为 0，表示段选择符指向 GDT，从 GDT 中根据索引找到对应的段描述符。如果表指示符为 1，表示段选择符指向 LDT，从 LDT 中根据索引找到对应的段描述符。
    - 检查段描述符的有效性和访问权限，如果无效或不允许访问，产生异常。
    - 从段描述符中提取基地址、界限、属性等信息，将基地址加上偏移量，得到线性地址。

  - 把线性地址映射到物理地址：通过页机制，将线性地址转换为物理地址。具体步骤如下：
    - 从 CR3 寄存器中提取页目录的基地址，将线性地址的高 10 位作为索引，从页目录中找到对应的页目录项。
    - 检查页目录项的有效性和访问权限，如果无效或不允许访问，产生异常。
    - 从页目录项中提取页表的基地址，将线性地址的中间 10 位作为索引，从页表中找到对应的页表项。
    - 检查页表项的有效性和访问权限，如果无效或不允许访问，产生异常。
    - 从页表项中提取页的基地址，将线性地址的低 12 位作为偏移量，得到物理地址。

