

# 3.中断和异常处理

## 3.1. 中断和异常处理概述

- **什么是中断和异常？**
  - 中断和异常是指处理器在执行指令的过程中，由于某些事件的发生而暂时中止当前的执行流程，转而执行一个特定的处理程序。
  - 中断和异常的主要区别在于它们的来源和类型。中断通常是由外部设备或软件产生的，而异常是由处理器内部检测到的错误或特殊情况引起的。
  
- **处理器如何处理？**
  - 处理器通过使用一个中断向量表（Interrupt Vector Table，IVT）来处理中断和异常。IVT 是一个存放在内存中的表格，它包含了不同类型的中断和异常对应的处理程序的入口地址。
  
  - 当处理器检测到一个中断或异常时，它会根据事件的编号（也称为向量）在 IVT 中查找相应的处理程序的地址，然后保存当前的执行状态（如程序计数器、标志寄存器等），并跳转到该地址开始执行处理程序。
  
  - 处理程序执行完毕后，处理器会恢复之前保存的执行状态，并返回到被中断或异常的指令继续执行。
  
    ![](/images/img1.png)
  
- **思考：实模式和保护模式下，中断向量表一样吗？**
  - 不一样。实模式下，IVT 的大小是 256 个字节，每个字节对应一个中断或异常向量，每个向量包含一个 16 位的段选择子和一个 16 位的偏移量，组成一个 32 位的线性地址。
  - 保护模式下，IVT 的大小是 1024 个字节，每个字节对应一个中断或异常向量，每个向量包含一个 8 位的中断描述符表（Interrupt Descriptor Table，IDT）选择子和一个 32 位的偏移量，组成一个 48 位的门描述符（Gate Descriptor）。IDT 是一个存放在内存中的表格，它包含了不同类型的门描述符，用于描述处理程序的属性和地址。

## 3.2. 有关中断和异常了解性的内容

- **中断和异常向量**
  - 中断和异常向量是一个 8 位的无符号整数，用于标识不同类型的中断和异常事件。
  - 中断和异常向量的范围是 0 到 255，其中 0 到 31 是由处理器预定义的异常向量，32 到 255 是由操作系统或用户自定义的中断向量。
  
- **中断源和异常源**
  - 中断源是指产生中断的设备或软件，例如键盘、鼠标、时钟、网络适配器等外部设备，或者是操作系统或用户程序发出的中断指令（如 int、int3、into 等）。
  - 异常源是指导致异常的错误或特殊情况，例如除法溢出、缺页、保护错误、对齐检查、机器检查等处理器内部检测到的情况。
  
- **异常的分类：故障、陷阱和中止**
  - 异常可以根据它们的发生时机和处理方式分为三类：故障（Fault）、陷阱（Trap）和中止（Abort）。
  - 故障是一种可以被纠正的异常，它通常是由于程序的错误或缺乏资源导致的。处理器在发生故障时，会保存引起故障的指令的地址，然后执行故障处理程序。处理程序完成后，处理器会重新执行引起故障的指令，从而恢复正常的执行流程。例如，缺页异常就是一种故障，它表示虚拟内存中的某个页面没有被加载到物理内存中，需要操作系统将其调入并更新页表。
  - 陷阱是一种用于实现系统调用或调试功能的异常，它通常是由于程序的正常请求或指令的执行导致的。处理器在发生陷阱时，会保存陷阱指令的下一条指令的地址，然后执行陷阱处理程序。处理程序完成后，处理器会继续执行陷阱指令的下一条指令，从而维持正常的执行流程。例如，int 指令就是一种陷阱，它可以用于实现系统调用，让用户程序请求操作系统的服务。
  - 中止是一种无法被纠正的异常，它通常是由于处理器的严重错误或不一致导致的。处理器在发生中止时，会保存一个不确定的地址，然后执行中止处理程序。处理程序通常无法恢复正常的执行流程，只能终止程序或重启系统。例如，机器检查异常就是一种中止，它表示处理器检测到了一个硬件故障或系统错误。
  
- **程序或任务的重新执行**
  - 程序或任务的重新执行是指处理器在执行完异常或中断处理程序后，返回到被中断或异常的指令继续执行的过程。
  - 程序或任务的重新执行的方式取决于异常或中断的类型。对于故障，处理器会重新执行引起故障的指令，从而纠正错误或补充资源。对于陷阱，处理器会继续执行陷阱指令的下一条指令，从而实现系统调用或调试功能。对于中止，处理器通常无法重新执行，只能终止程序或重启系统。
  
- **开启和禁止中断**
  - 开启和禁止中断是指处理器是否响应外部设备或软件产生的中断的状态。
  - 处理器可以通过设置标志寄存器中的 IF 位来开启或禁止中断。当 IF 位为 1 时，表示处理器可以响应中断。当 IF 位为 0 时，表示处理器不响应中断。
  - 处理器可以通过执行特定的指令来改变 IF 位的值。例如，sti 指令可以将 IF 位设置为 1，从而开启中断。cli 指令可以将 IF 位设置为 0，从而禁止中断。
  
- **异常和中断的优先级**
  - 异常和中断的优先级是指处理器在处理多个异常或中断时，按照一定的规则，决定哪个异常或中断先处理，哪个后处理。
  
  - 异常和中断的优先级主要由以下几个因素决定：
    - 异常或中断的来源：处理器会根据异常或中断的来源，将它们分为以下四类：
      - 外部中断：由外部设备或软件产生的中断，如键盘、鼠标、时钟、系统调用等。
      - 内部异常：由处理器内部检测到的异常，如除法错误、缺页、保护错误等。
      - 软件异常：由软件主动触发的异常，如断点、溢出、单步执行等。
      - 任务切换：由任务门或任务寄存器产生的任务切换请求。
    - 异常或中断的向量：处理器会根据异常或中断的向量，将它们分为以下两类：
      - 非屏蔽中断：向量为 0 到 31 的异常或中断，它们不能被屏蔽或忽略，必须立即处理。
      - 可屏蔽中断：向量为 32 到 255 的异常或中断，它们可以被屏蔽或忽略，不一定立即处理。
    - 处理器的状态：处理器会根据自身的状态，影响异常或中断的处理方式：
      - 中断标志位：如果处理器的中断标志位（IF）为 0，表示关闭了中断，那么处理器只会处理非屏蔽中断，而忽略可屏蔽中断1。如果处理器的中断标志位（IF）为 1，表示开启了中断，那么处理器会处理所有的异常或中断。
      - 中断优先级：如果处理器正在处理一个异常或中断，那么它只会响应优先级更高的异常或中断，而忽略优先级相同或更低的异常或中断1。优先级的判断规则如下：
        - 如果两个异常或中断的来源不同，那么按照以下顺序判断优先级：内部异常 > 外部中断 > 软件异常 > 任务切换。
        - 如果两个异常或中断的来源相同，那么按照以下规则判断优先级：非屏蔽中断 > 可屏蔽中断；向量小的 > 向量大的。
    
  - 异常和中断的优先级的作用是保证处理器能够及时响应重要的异常或中断，避免丢失或延误信息，同时也能防止被低优先级的异常或中断干扰或破坏。
  
    ![](/images/img2.png)

## 3.3. 中断描述符表

- **如何构成？**
  - 中断描述符表（Interrupt Descriptor Table，IDT）是一个存放在内存中的表格，它包含了不同类型的门描述符，用于描述处理程序的属性和地址。
  - IDT 的大小是 1024 个字节，每个字节对应一个中断或异常向量，每个向量包含一个 8 位的中断描述符表选择子和一个 32 位的偏移量，组成一个 48 位的门描述符。
  - IDT 的位置由一个特殊的寄存器 IDTR 指定，IDTR 包含一个 16 位的限长和一个 32 位的基址，表示 IDT 的大小和起始地址。
  
- **如何获得中断处理程序的地址**？**
  - 当处理器检测到一个中断或异常时，它会根据事件的编号（也称为向量）在 IDT 中查找相应的门描述符，然后从门描述符中提取出中断描述符表选择子和偏移量，组成一个 48 位的线性地址。
  - 中断描述符表选择子是一个段选择子，它用于在全局描述符表（Global Descriptor Table，GDT）中查找相应的段描述符，从而获得段的基址、限长和属性。
  - 偏移量是一个相对于段基址的偏移量，它用于定位处理程序在段内的位置。
  - 处理器将段基址和偏移量相加，得到处理程序的线性地址，然后根据分页机制将其转换为物理地址，从而开始执行处理程序。
  
- **如何设置中断描述符表寄存器？**
  - 设置中断描述符表寄存器（IDTR）的方法有两种：一种是使用 lidt 指令，另一种是使用 mov 指令。
  
  - lidt 指令的操作数是一个内存地址，该地址指向一个 6 字节的数据结构，其中包含 IDT 的限长和基址。lidt 指令会将这个数据结构的内容加载到 IDTR 中，从而设置 IDT 的位置。
  
  - mov 指令的操作数是一个寄存器和 IDTR，例如 mov eax, idtr 或 mov idtr, eax。mov 指令会将寄存器的内容和 IDTR 之间进行传送，从而读取或设置 IDT 的位置。
  
    ![](/images/img3.png)

## 3.4. IDT 描述符

- 掌握以下描述符格式：

  - **中断门**

    - 中断门是一种用于处理中断的门描述符，它包含以下字段：

      - 偏移量的低 16 位：表示处理程序的偏移量的低 16 位。
      - 中断描述符表选择子：表示处理程序的段选择子。
      - 保留位：必须为 0。
      - 类型：表示门描述符的类型，对于中断门，该字段的值为 0xE。
      - 存储段：表示是否将门描述符存储在段中，对于中断门，该字段的值为 0。
      - 权限级别：表示门描述符的特权级别，取值为 0 到 3，其中 0 表示最高，3 表示最低。
      - 存在位：表示门描述符是否存在，取值为 0 或 1，其中 1 表示存在，0 表示不存在。
      - 偏移量的高 16 位：表示处理程序的偏移量的高 16 位。

    - 中断门的格式如下：

      <img src="/images/img4.png" style="zoom:150%;" />
    
  - **陷阱门**
  
    - 陷阱门是一种用于处理陷阱的门描述符，它包含以下字段：
  
      - 偏移量的低 16 位：表示处理程序的偏移量的低 16 位。
      - 中断描述符表选择子：表示处理程序的段选择子。
      - 保留位：必须为 0。
      - 类型：表示门描述符的类型，对于陷阱门，该字段的值为 0xF。
      - 存储段：表示是否将门描述符存储在段中，对于陷阱门，该字段的值为 0。
      - 权限级别：表示门描述符的特权级别，取值为 0 到 3，其中 0 表示最高，3 表示最低。
      - 存在位：表示门描述符是否存在，取值为 0 或 1，其中 1 表示存在，0 表示不存在。
      - 偏移量的高 16 位：表示处理程序的偏移量的高 16 位。
  
    - 陷阱门的格式如下：
  
      <img src="/images/img5.png" style="zoom: 150%;" />
    
  - **任务门**
  
    - 任务门是一种用于实现任务切换的门描述符，它包含以下字段：
  
      - 任务描述符表选择子：表示任务的段选择子。
      - 保留位：必须为 0。
      - 类型：表示门描述符的类型，对于任务门，该字段的值为 0x5。
      - 保留位：必须为 0。
      - 权限级别：表示门描述符的特权级别，取值为 0 到 3，其中 0 表示最高，3 表示最低。
      - 存在位：表示门描述符是否存在，取值为 0 或 1，其中 1 表示存在，0 表示不存在。
      - 保留位：必须为 0。
  
    - 任务门的格式如下：

      <img src="/images/img6.png" style="zoom:150%;" />

## 3.5. 中断与异常处理

- **中断过程调用的流程是怎样的？**
  - 中断过程调用的流程可以分为以下几个步骤：
    - 处理器检测到一个中断或异常，保存当前的执行状态（如程序计数器、标志寄存器等），并关闭中断（将 IF 位清零）。
    
    - 处理器根据事件的编号（也称为向量）在 IDT 中查找相应的门描述符，然后从门描述符中提取出中断描述符表选择子和偏移量，组成一个 48 位的线性地址。
    
    - 处理器检查门描述符的存在位、特权级别和类型，如果有错误，抛出一个异常。
    
    - 处理器根据中断描述符表选择子在 GDT 中查找相应的段描述符，然后从段描述符中提取出段的基址、限长和属性。
    
    - 处理器检查段描述符的存在位、特权级别和类型，如果有错误，抛出一个异常。
    
    - 处理器将段基址和偏移量相加，得到处理程序的线性地址，然后根据分页机制将其转换为物理地址。
    
    - 处理器根据门描述符的类型，执行不同的操作：
      - 如果是中断门或陷阱门，处理器会将当前的代码段选择子和程序计数器压入堆栈，然后跳转到处理程序的地址。
      - 如果是任务门，处理器会执行一个任务切换，将当前任务的状态保存到任务状态段（Task State Segment，TSS），然后从任务门中的任务描述符表选择子指定的任务状态段中恢复新任务的状态，并跳转到新任务的地址。
      
    - 处理程序执行完毕后，处理器会执行一个中断返回指令（iret），从堆栈中弹出之前保存的代码段选择子和程序计数器，恢复执行状态，并开启中断（将 IF 位置一）。
    
      ![](/images/img7.png)
  
- **如何判断中断处理过程与被中断任务的优先级？**
  - 中断处理过程与被中断任务的优先级可以通过比较它们的特权级别来判断。
  - 特权级别是一个 2 位的无符号整数，取值为 0 到 3，其中 0 表示最高，3 表示最低。
  - 中断处理过程的特权级别由门描述符和段描述符中的 DPL 字段决定，被中断任务的特权级别由代码段寄存器中的 CPL 字段决定。
  - 如果中断处理过程的特权级别等于被中断任务的特权级别，那么它们的优先级相同，称为同级中断。
  - 如果中断处理过程的特权级别低于被中断任务的特权级别，那么它的优先级高于被中断任务，称为上级中断。
  - 如果中断处理过程的特权级别高于被中断任务的特权级别，那么它的优先级低于被中断任务，称为下级中断。这种情况通常是不允许的，会导致一个异常。
  
- **不同优先级上，处理方式一样吗？**
  - 不一样。不同优先级上的中断处理方式主要有以下区别：
    - 同级中断：处理器不会改变当前的特权级别和堆栈，只会将当前的代码段选择子和程序计数器压入堆栈，然后跳转到处理程序的地址。
    - 上级中断：处理器会提升当前的特权级别和堆栈，将当前的代码段选择子、程序计数器、堆栈段选择子和堆栈指针压入堆栈，然后跳转到处理程序的地址。这种情况称为堆栈切换。
    - 下级中断：处理器会抛出一个异常，不会执行中断处理程序。
  
- **如果发生堆栈切换，处理器会做哪些操作？**
  - 如果发生堆栈切换，处理器会做以下操作：
    - 处理器会根据中断处理过程的特权级别，从任务寄存器中的任务状态段中获取相应的堆栈段选择子和堆栈指针。
    - 处理器会检查堆栈段选择子在 GDT 中对应的段描述符的存在位、特权级别和类型，如果有错误，抛出一个异常。
    - 处理器会将堆栈段选择子加载到堆栈段寄存器中，并将堆栈指针加载到堆栈指针寄存器中。
    - 处理器会将当前的代码段选择子、程序计数器、堆栈段选择子和堆栈指针压入新的堆栈中。
  
- **如果没发生堆栈切换，处理器会做哪些操作？**
  - 如果没发生堆栈切换，处理器会做以下操作：
    - 处理器会将当前的代码段选择子和程序计数器压入当前的堆栈中。
  
- **中断处理过程后，如何返回，处理器做了哪些操作？**
  - 中断处理过程后，处理器会执行一个中断返回指令（iret），从堆栈中弹出之前保存的代码段选择子和程序计数器，恢复执行状态，并开启中断（将 IF 位置一）。
  
  - 处理器做了以下操作：
    - 处理器会检查堆栈中的代码段选择子在 GDT 中对应的段描述符的存在位、特权级别和类型，如果有错误，抛出一个异常。
    
    - 处理器会将堆栈中的代码段选择子加载到代码段寄存器中，并将堆栈中的程序计数器加载到程序计数器寄存器中。
    
    - 如果发生了堆栈切换，处理器还会做以下操作：
      - 处理器会检查堆栈中的堆栈段选择子在 GDT 中对应的段描述符的存在位、特权级别和类型，如果有错误，抛出一个异常。
      - 处理器会将堆栈中的堆栈段选择子加载到堆栈段寄存器中，并将堆栈中的堆栈指针加载到堆栈指针寄存器中。
      
    - 处理器会从堆栈中弹出标志寄存器，并将 IF 位置一，开启中断。
    
      ![](/images/img8.png)
  
- **异常和中断处理过程的保护**
  - 异常和中断处理过程的保护是指处理器在执行异常或中断处理程序时，采取的一些措施，以防止被其他的异常或中断干扰或破坏。
  - 异常和中断处理过程的保护主要有以下几种方式：
    - 关闭中断：处理器在执行异常或中断处理程序时，会关闭中断（将 IF 位清零），以防止被外部设备或软件产生的中断打断。处理器在返回到被中断或异常的指令时，会开启中断（将 IF 位置一）。
    - 设置优先级：处理器在执行异常或中断处理程序时，会提升当前的特权级别（将 CPL 设置为处理程序的 DPL），以防止被低优先级的异常或中断打断1。处理器在返回到被中断或异常的指令时，会恢复原来的特权级别（将 CPL 设置为被中断或异常的指令的 DPL）。
    - 使用嵌套任务：处理器在执行异常或中断处理程序时，可以使用任务切换的机制，将当前任务的状态保存到任务状态段（Task State Segment，TSS），并从任务门中指定的任务状态段中恢复新任务的状态。这样可以保护当前任务的寄存器、堆栈和内存等资源，防止被处理程序破坏。处理器在返回到被中断或异常的指令时，可以再次使用任务切换的机制，恢复原来的任务的状态。
  
- **异常和中断处理过程的标志使用方式**
  - 异常和中断处理过程的标志使用方式是指处理器在执行异常或中断处理程序时，对标志寄存器中的各个标志位的操作和含义。
  - 异常和中断处理过程的标志使用方式主要有以下几种：
    - 保存和恢复标志：处理器在执行异常或中断处理程序时，会将标志寄存器的内容压入堆栈，以保存当前的执行状态。处理器在返回到被中断或异常的指令时，会从堆栈中弹出标志寄存器的内容，以恢复原来的执行状态。
    - 关闭和开启中断：处理器在执行异常或中断处理程序时，会关闭中断（将 IF 位清零），以防止被外部设备或软件产生的中断打断。处理器在返回到被中断或异常的指令时，会开启中断（将 IF 位置一）。
    - 设置方向标志：处理器在执行异常或中断处理程序时，会设置方向标志（将 DF 位设置为 0），以使字符串操作指令从低地址到高地址进行操作。处理器在返回到被中断或异常的指令时，会恢复方向标志（将 DF 位恢复为原来的值）。
    - 设置嵌套任务标志：处理器在执行异常或中断处理程序时，如果使用了任务切换的机制，会设置嵌套任务标志（将 NT 位设置为 1），以表示当前任务是一个嵌套任务。处理器在返回到被中断或异常的指令时，如果使用了任务切换的机制，会清除嵌套任务标志（将 NT 位清零），以表示当前任务是一个正常任务。
  
- **中断门与陷阱门的唯一区别是什么？**
  - 中断门与陷阱门的唯一区别是在执行异常或中断处理程序时，是否关闭中断。
  - 中断门在执行异常或中断处理程序时，会关闭中断（将 IF 位清零），以防止被外部设备或软件产生的中断打断。中断门在返回到被中断或异常的指令时，会开启中断（将 IF 位置一）。
  - 陷阱门在执行异常或中断处理程序时，不会关闭中断（保持 IF 位不变），以允许被外部设备或软件产生的中断打断。陷阱门在返回到被中断或异常的指令时，不会开启中断（保持 IF 位不变）。
  - 中断门和陷阱门的其他方面，如格式、特权级别、堆栈切换等，都是相同的。